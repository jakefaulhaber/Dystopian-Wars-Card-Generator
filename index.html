<html>
<head>
	<title>Jorbat</title>
	<link rel="stylesheet" type="text/css" href="cards.css">

	<script src="js/utility.js"></script>
	<script src="data/ships_imperium.js"></script>
	<script src="data/properties.js"></script>
	<script src="data/srs_properties.js"></script>
	<script src="data/qualities.js"></script>
	<script src="data/systems.js"></script>

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link defer href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&family=Special+Elite&display=swap" rel="stylesheet">


	<script>
		const savedOptions = {}
		const savedOptionsString = getCookie('options')
		let savedList = getCookie('list') || ''

		if (savedOptionsString) {
			Object.assign(savedOptions, JSON.parse(savedOptionsString))
		}

		console.log({savedOptions})

		function selectFaction(e, faction) {
			if (faction) {
				const select = document.querySelector('#faction_select')
				select.value = faction
			} else {
				faction = e.target.value
				setCookie('faction', faction, 365)
				setCookie('options', '', 0)
			}
			init(faction)
		}

		function clearOptions() {
			setCookie('options', '', 0)
		}

		function saveOption(e) {
			console.log('saveOption')
			setCookie('options', JSON.stringify(savedOptions), 365)
		}

		function saveList(e) {
			let newSavedList = ''
			document.querySelectorAll('.list input:checked').forEach((input) => {
				if (input.checked) {
					newSavedList += newSavedList ? ',' + input.value : input.value
				}
			})

			if (newSavedList != savedList) {
				setCookie('list', newSavedList, 365)
				savedList = newSavedList
				init(getCookie('faction'))
			}

			setCookie('list', savedList, 365)
		}

		function getShipData(shipName) {
			console.log('getShipData', shipName, window[getCookie('faction') + '_ships'])
			return window[getCookie('faction') + '_ships'].find((ship) => ship.name == shipName)
		}

		function init(faction) {
			const output = $('.output')
			const listElement = $('.list')
			listElement.innerHTML = ''
			output.innerHTML = ''

			const shipData = window[faction + '_ships']
			document.querySelector('.rules_cards').innerHTML = ''

			console.log('init', faction, faction + '_ships', shipData)

			// loop over object
			Object.keys(shipData).forEach((shipName) => {
				const ship = shipData[shipName]
				let displayName = ship.name
				let shipClass = ship.class
				if (displayName.indexOf('CONFIGURATION') > -1) {
					displayName = ship?.class
					shipClass = ship?.name
				}
				listElement.innerHTML += `<label>
					<input type="checkbox" onchange="saveList(event)" ${savedList.indexOf(ship.name) > -1 ? 'checked' : ''} value="${shipName}" />
					<div>
						${displayName}
						${shipClass ? `<sub>${shipClass}</sub>` : ''}
					</div>
				</label>`
			})

			const ships = savedList.length ? savedList.split(',') : []


			const rulesCardRules = []
			const weaponQualities = {}

			ships.forEach((shipKey) => {
				const ship = shipData[shipKey]
				const shipName = ship.name
				const card = $('.template .card').cloneNode(true)
				card.dataset.ship = ship.name
				

				let displayName = ship?.name
				let shipClass = ship?.class
				if (shipName.indexOf('CONFIGURATION') > -1) {
					displayName = ship?.class
					shipClass = ship?.name
				}

				card.find('.name').innerHTML = displayName
				card.find('.class').innerHTML = shipClass
				
				if (ship.points >= 100) {
					card.find('.points').classList.add('points_wide')
				}
				
				card.find('.points_value').innerHTML = ship?.points
				card.find('.vpr_value').innerHTML = ship?.vpr

				card.find('.mas').innerHTML = ship.stats.mas
				card.find('.spd').innerHTML = ship.stats.spd
				card.find('.trn').innerHTML = ship.stats.trn
				card.find('.def').innerHTML = ship.stats.def
				card.find('.arm').innerHTML = ship.stats.arm
				card.find('.hul').innerHTML = ship.stats.hul
				card.find('.act').innerHTML = ship.stats.act
				card.find('.brd').innerHTML = ship.stats.brd
				card.find('.rep').innerHTML = ship.stats.rep
				card.find('.crw').innerHTML = ship.stats.crw

				card.find('.traits').innerHTML = ship.traits.join(', ')

				function slugify_rule(rule) {
					let slug = rule
					if (rule.indexOf(':') > -1) {
						slug = rule.split(':')[0]
					}
					slug = slug.replace(/\(.*?\)/g, '').trim()
					slug = slug.toLowerCase().replace(/ /g, '_')
					return slug
				}

				function cleanupRuleName(rule) {
					return rule.replace(/\(.*?\)/g, '(X)').trim()
				}

				function cleanupRule(rule) {
					const cites = rule.matchAll(/\[cite:(.*?)\]/g)
					if (cites) {
						cites.forEach((cite) => {
							rule = rule.replace(cite[0], '<cite>[cite: ' + cite[1] + ']</cite>')
						})
					}

					rule = rule.replaceAll(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')

					let inchMatches = rule.matchAll(/\$(.)\^{"}\$/g)
					if (inchMatches) {
						inchMatches.forEach((match) => {
							rule = rule.replace(match[0], '<strong>' + match[1] + '"</strong>')
						})
					}
					return rule
				}

				function cleanupQualityName(quality) {
					let qualityName = quality
					if (quality.indexOf(':') > -1) {
						qualityName = quality.split(':')[0]
						if (quality.indexOf('(X)') > -1) {
							qualityName += ' (X)'
						}
					}
					return qualityName.replace(/\(.*?\)/g, '(X)').trim()
				}

				const simpleProperties = ['boarding_parties']

				const propertiesWrapperElement = card.find('.properties_content')
				ship.properties.map((property, propertyId) => {
					const propertyElement = document.createElement('div')
					propertyElement.classList.add('property')
					propertyElement.innerHTML = `<strong>${property}</strong>`
					const propertySlug = slugify_rule(property)
					if (!simpleProperties.includes(propertySlug)) {
						// propertyElement.innerHTML += `<p>${cleanupRule(window.properties?.[propertySlug]?.value || '')}</p>`
					}
					rulesCardRules.push(property)
					propertiesWrapperElement.appendChild(propertyElement)
				})

				const simpleSystems = ['']

				const systemsWrapperElement = card.find('.systems_content')
				ship.systems.map((system, systemId) => {
					const systemElement = document.createElement('div')
					systemElement.classList.add('system')
					systemElement.innerHTML = `<strong>${system}</strong>`
					const systemSlug = slugify_rule(system)
					if (!simpleSystems.includes(systemSlug)) {
						// systemElement.innerHTML += `<p>${cleanupRule(window.systems?.[systemSlug]?.value || '')}</p>`
					}
					rulesCardRules.push(system)
					systemsWrapperElement.appendChild(systemElement)
				})

				const mainRulesElement = card.find('.rules.main')

				const weaponWrapperElement = card.find('.weapons tbody')

				ship.weapons.map((weapon, weaponId) => {
					const weaponRow = document.createElement('tr')
					weaponRow.classList.add('weapon_name')
					weaponWrapperElement.appendChild(weaponRow)
					weaponRow.innerHTML = `
						<td>${weapon.name}</td>
						<td>${weapon.arc}</td>
						<td>${weapon.firepower_c || '-'}</td>
						<td>${weapon.firepower_s || '-'}</td>
						<td>${weapon.firepower_e || '-'}</td>
					`
					const qualitiesRow = document.createElement('tr')
					qualitiesRow.classList.add('qualities')
					weapon.qualities.map((quality) => {
						weaponQualities[quality.replace(/\(.*?\)/g, '(X)').trim()] = true
					})
					qualitiesRow.innerHTML = `
						<td colspan="5">${weapon.qualities.join(', ')}</td>
					`
					weaponWrapperElement.appendChild(qualitiesRow)
				})

				output.append(card)

				const rulesCard = document.createElement('div')
				rulesCard.classList.add('rules_card')
				$('.rules_cards').append(rulesCard)
				rulesCardRules.sort().map((rule) => {
					const ruleSlug = slugify_rule(rule)
					const ruleValue = window.properties?.[ruleSlug]?.value || window.systems?.[ruleSlug]?.value || ''
					rulesCard.innerHTML += `<strong>${cleanupRuleName(rule)}</strong><p>${cleanupRule(ruleValue)}</p>`
				})

				const qualitiesCard = document.createElement('div')
				qualitiesCard.classList.add('rules_card')
				$('.rules_cards').append(qualitiesCard)
				Object.keys(weaponQualities).sort().map((quality) => {
					qualitiesCard.innerHTML += `<strong>${cleanupQualityName(quality)}</strong><p>${cleanupRule(window.qualities?.[slugify_rule(quality)]?.value || '')}</p>`
				})

			})
		}

		window.addEventListener('load', () => {
			const faction = getCookie('faction') || 'imperium'
			setCookie('faction', faction, 365)
			selectFaction(null, faction)
			changePrintLayout(getCookie('print_layout') || 'layout_1')
		})

		function changePrintLayout(setLayout) {
			const currentLayout = setLayout || document.querySelector('#print_layout').value
			document.body.classList.remove('layout_1', 'layout_2', 'layout_3')
			document.body.classList.add(currentLayout)
			document.querySelector('#print_layout').value = currentLayout
			setCookie('print_layout', currentLayout, 365)
		}

		function onChangePrintLayout(e) {
			changePrintLayout(e.target.value)
		}

		window.addEventListener("beforeprint", (event) => {
			const cards = document.querySelectorAll('.output .card')
			const rulesCards = document.querySelectorAll('.output .rules_card')
			cards.forEach((card) => {
				const mainRules = card.querySelector('.rules.main')
				const secondaryRules = card.querySelector('.rules.secondary')
				const commonRules = card.querySelector('.rules.common')

				card.mainRules = mainRules
				card.secondaryRules = secondaryRules
				card.commonRules = commonRules

				const maxHeight = 400

				if (mainRules.offsetHeight > maxHeight) {
					card.classList.add('hide_card_rules')
				} else if (mainRules.offsetHeight > maxHeight) {
					card.classList.add('hide_card_rules')
				} else {
					// Hide separate rules card if we don't need it.
					if (card?.nextElementSibling) {
						card.nextElementSibling.style.display = 'none'
					}
				}
			})

			rulesCards.forEach((card) => {
				const maxHeight = 880

				const displaySetting = card.style.display
				card.style.display = 'block'
				if (card.offsetHeight > maxHeight) {
					card.classList.add('compact')
				}
				card.style.display = displaySetting
			})
		});

		window.addEventListener('afterprint', (event) => {
			const cards = document.querySelectorAll('.output .card')
			cards.forEach((card) => {
				card.classList.remove('hide_card_rules')
				// card.nextElementSibling.style.display = ''
			})
		});


	</script>    
</head>
<body>
	<div class="nav">
		<button onclick="clearOptions()">Clear</button>
		<select id="faction_select" onchange="selectFaction(event)">
			<option value="imperium">Imperium</option>
		</select>

		<select id="print_layout" onChange="onChangePrintLayout(event)" style="position: absolute; top: 50%; right: 1rem; transform: translateY(-50%);">
			<option value="layout_1">Print 8.5" x 11" (Use landscape)</option>
			<option value="layout_2">Print Tarot (Use landscape)</option>
			<option value="layout_3">Print 4"x6" 1 per page</option>
		</select>
	</div>

	<div class="list"></div>

	<div class="output"></div>

	<div class="rules_cards"></div>

	<div class="template" style="display: none;">
		<div class="card">
			<div class="header">
				<div>
					<h1>
						<span class="name"></span>
					</h1>
					<h2 class="class"></h2>
					<div class="traits_wrapper">
						<div class="traits"></div>
					</div>
				</div>

				<div class="right">
					<div class="vpr">
						<span>VPR</span>
						<span class="vpr_value"></span>
					</div>
					<div class="points">
						<span>Points</span>
						<span class="points_value"></span>
					</div>
				</div>
			</div>
			<div class="stats">
				<table class="">
					<tr>
						<td>Mass</td>
						<td>Spd</td>
						<td>Trn</td>
						<td>Def</td>
						<td>Arm</td>
						<td>Hul</td>
						<td>Act</td>
						<td>Brd</td>
						<td>Rep</td>
						<td>Crw</td>
					</tr>
					<tr class="stat_values">
						<td class="mas"></td>
						<td class="spd"></td>
						<td class="trn"></td>
						<td class="def"></td>
						<td class="arm"></td>
						<td class="hul"></td>
						<td class="act"></td>
						<td class="brd"></td>
						<td class="rep"></td>
						<td class="crw"></td>
					</tr>
				</table>
			</div>

			<div class="props_system_wrapper">
				<div class="properties">
					<h3>Properties</h3>
					<div class="properties_content"></div>
				</div>
				<div class="systems">
					<h3>Systems</h3>
					<div class="systems_content"></div>
				</div>
			</div>
			
			<table class="weapons">
				<thead>
					<tr>
						<th>Weapon</th>
						<th>Arc</th>
						<th>C</th>
						<th>S</th>
						<th>E</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		
		</div>
	</div>
</html>